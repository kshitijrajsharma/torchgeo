name: tests
on:
  push:
    branches: [main, release**]
  pull_request:
    branches: [main, release**]
  workflow_dispatch:
defaults:
  run:
    shell: bash

jobs:
  tests:
    name: ${{ matrix.name || 'latest' }} (${{ matrix.os }}, ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.12', '3.13']
        install_cmd: ['uv sync --extra datasets --extra models --extra tests']

        include:
          # Minimum: Legacy install via pip install
          - name: minimum
            os: ubuntu-latest
            python-version: '3.12'
            install_cmd: 'uv pip install -r requirements/min-reqs.old'

          # Optional: Core + Tests only
          - name: optional
            os: ubuntu-latest
            python-version: '3.13'
            install_cmd: 'uv sync --extra tests'

    steps:
      - uses: actions/checkout@v6.0.1

      - uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true

      - name: Install dependencies
        # Dynamically runs either 'uv sync' or 'uv pip install' to support minimum deps
        run: |
          # Create venv if using pip install mode (uv sync creates it automatically)
          if [[ "${{ matrix.name }}" == "minimum" ]]; then
            uv venv
          fi
          UV_RESOLUTION=highest ${{ matrix.install_cmd }}

      - name: List installed dependencies
        run: |
          echo "=== Installed packages ==="
          uv pip list
          echo "=== Python/uv info ==="
          uv run python --version
          uv --version


      - name: Run checks
        run: |
          uv run pytest --cov=torchgeo --cov-report=xml
          uv run torchgeo --help

      - uses: codecov/codecov-action@v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.head.label || github.head_ref || github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}
